<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORE | AI MENTOR</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00F3FF">
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        /* CHAT CONTAINER */
        .chat-frame {
            height: 75vh;
            display: flex;
            flex-direction: column;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--neon-cyan);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        /* MESSAGES AREA */
        .chat-box {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* MESSAGE BUBBLES */
        .msg {
            max-width: 80%;
            padding: 0.8rem 1.2rem;
            border-radius: 10px;
            font-size: 0.95rem;
            line-height: 1.5;
            position: relative;
        }
        .msg-ai {
            align-self: flex-start;
            background: rgba(0, 243, 255, 0.1);
            border-left: 3px solid var(--neon-cyan);
            color: white;
        }
        .msg-user {
            align-self: flex-end;
            background: rgba(255, 215, 0, 0.1);
            border-right: 3px solid gold;
            color: white;
            text-align: right;
        }

        /* INPUT AREA */
        .input-area {
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            display: flex;
            gap: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .chat-input {
            flex: 1;
            padding: 1rem;
            border-radius: 50px;
            border: 1px solid var(--glass-border);
            background: rgba(0,0,0,0.5);
            color: white;
            outline: none;
            font-family: 'Space Grotesk';
        }
        .chat-input:focus { border-color: var(--neon-cyan); }

        /* MIC BUTTON (ANIMATED) */
        .mic-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.1);
            color: gray;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        .mic-btn.listening {
            background: #ff2e2e;
            color: white;
            box-shadow: 0 0 15px #ff2e2e;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* MODE SWITCH */
        .mode-switch {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
            background: black;
            padding: 5px 10px;
            border-radius: 20px;
            border: 1px solid gray;
            font-size: 0.7rem;
            color: gray;
            cursor: pointer;
        }
        .mode-switch.voice-active { border-color: var(--neon-cyan); color: var(--neon-cyan); }
    </style>
</head>
<body>

    <nav class="glass-panel" style="position: fixed; top: 0; width: 100%; z-index: 100;">
        <div class="logo">C.O.R.E <span class="blink">_</span></div>
        <div class="user-menu"><a href="dashboard.html" class="btn-secondary">RETURN TO BASE</a></div>
    </nav>

    <div class="dashboard-container">
        <aside class="sidebar">
            <a href="dashboard.html"><i class="fa-solid fa-chart-line"></i> OVERVIEW</a>
            <a href="learning.html"><i class="fa-solid fa-graduation-cap"></i> LEARNING HUB</a>
            <a href="project.html"><i class="fa-solid fa-microchip"></i> PROJECT LAB</a>
            <a href="labs.html"><i class="fa-solid fa-flask"></i> VIRTUAL LABS</a>
            <a href="library.html"><i class="fa-solid fa-book"></i> LIBRARY</a>
            <a href="ai_assistant.html" class="active"><i class="fa-solid fa-robot"></i> AI MENTOR</a>
            <a href="community.html"><i class="fa-solid fa-users"></i> COMMUNITY</a>
            <a href="leaderboard.html"><i class="fa-solid fa-trophy"></i> LEADERBOARD</a>
            <a href="profile.html"><i class="fa-solid fa-id-card"></i> MY PROFILE</a>
            <a href="about.html"><i class="fa-solid fa-circle-info"></i> SYSTEM INFO</a>
        </aside>

        <main class="main-content">
            
            <div class="section-header">
                <h2>C.O.R.E. INTELLIGENCE (GPT-4)</h2>
                <div class="line"></div>
            </div>

            <div class="chat-frame">
                <div id="voice-toggle" class="mode-switch" onclick="toggleVoiceMode()">
                    <i class="fa-solid fa-volume-high"></i> VOICE OUTPUT: OFF
                </div>

                <div id="chat-box" class="chat-box">
                    <div class="msg msg-ai">
                        <strong>SYSTEM:</strong> Online. I am connected to OpenAI servers. Ask me about electronics, code, or robotics.
                    </div>
                </div>

                <div class="input-area">
                    <button id="mic-btn" class="mic-btn" onclick="toggleMic()">
                        <i class="fa-solid fa-microphone"></i>
                    </button>
                    <input type="text" id="user-input" class="chat-input" placeholder="Ask about Arduino, ROS, PCBs..." onkeypress="handleEnter(event)">
                    <button class="mic-btn" style="background: var(--neon-cyan); color: black;" onclick="sendMessage()">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </div>

        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        // --- 1. CONFIGURATION ---
        // ⚠️ PASTE YOUR OPENAI API KEY HERE (Starts with sk-...)
        const OPENAI_API_KEY = "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"; 
        
        let voiceMode = false;
        let recognition;
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const micBtn = document.getElementById('mic-btn');

        // --- 2. VOICE RECOGNITION SETUP ---
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                micBtn.classList.add('listening');
            };

            recognition.onend = () => {
                micBtn.classList.remove('listening');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                userInput.value = transcript;
                sendMessage(); // Auto-send when speaking stops
            };
        } else {
            console.log("Voice Input not supported in this browser.");
        }

        // --- 3. FUNCTIONS ---
        function toggleVoiceMode() {
            voiceMode = !voiceMode;
            const toggle = document.getElementById('voice-toggle');
            if(voiceMode) {
                toggle.classList.add('voice-active');
                toggle.innerHTML = '<i class="fa-solid fa-volume-high"></i> VOICE OUTPUT: ON';
                speak("Voice Interface Activated.");
            } else {
                toggle.classList.remove('voice-active');
                toggle.innerHTML = '<i class="fa-solid fa-volume-xmark"></i> VOICE OUTPUT: OFF';
                window.speechSynthesis.cancel();
            }
        }

        function toggleMic() {
            if (micBtn.classList.contains('listening')) recognition.stop();
            else recognition.start();
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }

        function addMessage(text, sender) {
            const div = document.createElement('div');
            div.className = `msg msg-${sender}`;
            div.innerHTML = sender === 'ai' ? `<strong>CORE:</strong> ${text}` : text;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // --- 4. CORE INTELLIGENCE (THE BRAIN - OPENAI VERSION) ---
        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            addMessage(text, 'user');
            userInput.value = '';

            // Loading Indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'msg msg-ai';
            loadingDiv.innerText = "Processing...";
            loadingDiv.id = "loading-msg";
            chatBox.appendChild(loadingDiv);

            let aiResponse = "";

            if (OPENAI_API_KEY) {
                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${OPENAI_API_KEY}`
                        },
                        body: JSON.stringify({
                            model: "gpt-3.5-turbo", // You can change to "gpt-4" if you have access
                            messages: [
                                { role: "system", content: "You are C.O.R.E., a concise robotics and electronics expert assistant. Keep answers brief unless code is requested." },
                                { role: "user", content: text }
                            ],
                            max_tokens: 150
                        })
                    });

                    const data = await response.json();
                    
                    if(data.error) {
                        aiResponse = "Error: " + data.error.message;
                    } else {
                        aiResponse = data.choices[0].message.content;
                    }
                } catch (e) {
                    aiResponse = "Connection Error. Check your internet or OpenAI API Key.";
                    console.error(e);
                }
            } else {
                aiResponse = "Offline Mode. Please add your OpenAI API Key (sk-...) to line 169.";
            }

            document.getElementById('loading-msg').remove();
            addMessage(aiResponse, 'ai');

            if (voiceMode) speak(aiResponse);
        }

        function speak(text) {
            if (!voiceMode) return;
            const cleanText = text.replace(/[*`]/g, ''); 
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.rate = 1.1;
            window.speechSynthesis.speak(utterance);
        }
    </script>
</body>
</html>